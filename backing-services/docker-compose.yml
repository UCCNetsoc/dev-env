version: "3.7"
services:
  mysql:
    image: uccnetsoc/mysql:dev-env
    container_name: mysql.netsoc.local
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - 3306:3306
    depends_on:
      - proxy

  auth:
    image: uccnetsoc/ldap:dev-env
    ports:
      - 389:389
    depends_on:
      - proxy

  consul:
    image: consul:1.6.1
    container_name: consul.netsoc.local
    command: agent -server -bootstrap-expect 1 -ui -client 0.0.0.0
    environment:
      CONSUL_BIND_INTERFACE: eth0
    depends_on:
      - proxy
    ports:
      - 8500:8500
      - 8600:53/udp
      - 8400:8400

  vault:
    image: uccnetsoc/vault:dev-env
    container_name: vault.netsoc.local
    environment:
      VAULT_ADDR: http://0.0.0.0:8200
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_DEV_ROOT_TOKEN_ID: netsoc
      VAULT_TOKEN: netsoc
    ports:
      - 8200:8200
    depends_on:
      - proxy
      - auth
      - consul
    cap_add:
      - IPC_LOCK

  isso:
    image: uccnetsoc/isso:dev-env
    container_name: isso.netsoc.local
    ports:
      - 8181:8080
    depends_on:
      - mysql

  proxy:
    image: wernight/dante
    container_name: proxy.netsoc.local
    depends_on:
      - whoami
    ports:
      - "0.0.0.0:1080:1080"

  whoami:
    container_name: whoami.netsoc.local
    image: containous/whoami

  unitproxy:
    image: nginx:1.19.2
    container_name: unitproxy.netsoc.local
    depends_on:
      - unit
    volumes:
      - "./unitproxy/unitproxy.nginx.conf:/etc/nginx/conf.d/default.conf"
      - "./unitproxy/unitproxy.htpasswd:/unitproxy.htpasswd:ro"
      - "./unitproxy/unitproxy-fix-socket-permissions.sh:/docker-entrypoint.d/fix-socket-permssions.sh"
      - "unitsock:/var/run/:z"

  unit:
    privileged: true
    container_name: unit.netsoc.local
    cap_add:
      - ALL
    entrypoint: /usr/sbin/unitd --no-daemon --control unix:/var/run/control.unit.sock
    image: nginx/unit:1.19.0-full
    volumes:
      - "unitsock:/var/run/:z"
      - "./freeipa/home:/home/:z"

  ipa:
    container_name: ipa.netsoc.local
    image: freeipa/freeipa-server:latest
    command: >
      ipa-server-install
      --unattended
      --realm=netsoc.local
      --ds-password=netsoc_freeipa
      --admin-password=netsoc_freeipa
      --no-host-dns
    hostname: ipa.netsoc.local
    read_only: true
    environment:
      IPA_SERVER_HOSTNAME: ipa.netsoc.local
    tmpfs:
      - "/run"
      - "/tmp"
    volumes:
      - "/sys/fs/cgroup:/sys/fs/cgroup:ro"
      - "/etc/machine-id:/etc/machine-id:ro"
      - "./freeipa/data:/data:z"
    sysctls:
      #  Fixes:
      #  DEBUG The ipa-server-install command failed, exception:
      #  RuntimeError: IPv6 stack is enabled in the kernel but there is no interface that has ::1 address assigned.
      #  Add ::1 address resolution to "lo" interface. You might need to enable IPv6 on the interface "lo" in sysctl.conf.
      net.ipv6.conf.lo.disable_ipv6: 0

  ipaclient:
    container_name: ipaclient.netsoc.local
    hostname: ipaclient.netsoc.local
    image: adelton/freeipa-client
    restart: always
    depends_on:
      - ipa
    environment:
      PASSWORD: netsoc_freeipa
      IPA_CLIENT_INSTALL_OPTS: --server=ipa.netsoc.local --domain=netsoc.local --force-join
    volumes:
      - "./freeipa/home:/home/:Z"

  keycloak:
    container_name: keycloak.netsoc.local
    image: uccnetsoc/keycloak:dev-env
    environment:
      KEYCLOAK_USER: netsoc_keycloak
      KEYCLOAK_PASSWORD: netsoc_keycloak
      KEYCLOAK_IMPORT: /tmp/keycloak/freeipa-realm.json
      DB_VENDOR: H2
    depends_on:
      - ipa
    hostname: keycloak.netsoc.local
    volumes:
      - "./keycloak/:/tmp/keycloak/"
      - "./keycloak/krb5.keytab:/krb5.keytab"
      - "/etc/localtime:/etc/localtime:ro"

volumes:
  unitsock:
